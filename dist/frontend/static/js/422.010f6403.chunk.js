(self.webpackChunksocial_network_client=self.webpackChunksocial_network_client||[]).push([[422],{53694:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>V});var r=s(72791),o=s(66826),n=s(17531),i=s(72898);class a extends r.Component{constructor(){super(...arguments),this.componentDidMount=()=>{const{dispatch:e}=this.props;e(n.O.getChatRooms())},this.changeRoom=e=>{const{dispatch:t}=this.props;t(n.O.changeRoom(e))},this.handleSearch=e=>{const{dispatch:t,rooms:s,user:{data:r}}=this.props,o=s.filter((t=>{const s=t.members.filter((e=>e._id!==r._id));return s[0].firstName.toLocaleLowerCase().includes(e.target.value.toLocaleLowerCase())||s[0].lastName.toLocaleLowerCase().includes(e.target.value.toLocaleLowerCase())?t:null}));t(n.O.searchUsers(o))}}render(){const{user:e,rooms:t,searchedRooms:s,roomId:r}=this.props;const o=(s||t).map((t=>{const s=t.members.filter((t=>t._id!==e.data._id));let o="...";return t.lastMessage[0]&&t.lastMessage[0].sender===e.data._id?o="text"===t.lastMessage[0].messageType?"You: "+t.lastMessage[0].text:"You sent image ":t.lastMessage[0]&&(o="text"===t.lastMessage[0].messageType?t.lastMessage[0].text:"Image "),(0,i.jsx)("li",{className:t._id===r?"contact active":"contact",onClick:()=>this.changeRoom({...t,user:{...s[0]}}),children:(0,i.jsxs)("div",{className:"wrap",children:[(0,i.jsx)("span",{className:"contact-status ".concat(s[0].activityStatus)}),(0,i.jsx)("img",{src:"/images/profile-picture/100x100/".concat(s[0].profilePicture),alt:""}),(0,i.jsxs)("div",{className:"meta",children:[(0,i.jsx)("p",{className:"name",children:s[0].firstName+" "+s[0].lastName}),(0,i.jsx)("p",{className:"preview",children:o})]})]})},t._id)}));return(0,i.jsxs)("div",{id:"sidepanel",children:[(0,i.jsx)("div",{id:"profile",children:(0,i.jsxs)("div",{className:"wrap",children:[(0,i.jsx)("img",{id:"profile-img",src:"/images/profile-picture/100x100/".concat(e.data.profilePicture),className:"online",alt:""}),(0,i.jsx)("p",{children:e.data.firstName+" "+e.data.lastName}),(0,i.jsx)("i",{className:"fa fa-chevron-down expand-button","aria-hidden":"true"}),(0,i.jsx)("div",{id:"status-options",children:(0,i.jsxs)("ul",{children:[(0,i.jsxs)("li",{id:"status-online",className:"active",children:[(0,i.jsx)("span",{className:"status-circle"}),(0,i.jsx)("p",{children:"Online"})]}),(0,i.jsxs)("li",{id:"status-offline",children:[(0,i.jsx)("span",{className:"status-circle"}),(0,i.jsx)("p",{children:"Offline"})]})]})})]})}),(0,i.jsxs)("div",{id:"search",children:[(0,i.jsx)("label",{htmlFor:"",children:(0,i.jsx)("i",{className:"fa fa-search","aria-hidden":"true"})}),(0,i.jsx)("input",{type:"text",placeholder:"Search contacts...",onChange:this.handleSearch})]}),(0,i.jsx)("div",{id:"contacts",children:(0,i.jsx)("ul",{children:o.length?o:"No users"})}),(0,i.jsxs)("div",{id:"bottom-bar",children:[(0,i.jsxs)("button",{id:"addcontact",children:[(0,i.jsx)("i",{className:"fa fa-user-plus fa-fw","aria-hidden":"true"}),(0,i.jsx)("span",{children:"Add contact"})]}),(0,i.jsxs)("button",{id:"settings",children:[(0,i.jsx)("i",{className:"fa fa-cog fa-fw","aria-hidden":"true"}),(0,i.jsx)("span",{children:"Settings"})]})]})]})}}const c=(0,o.$j)((e=>({user:e.user,rooms:e.chat.rooms,searchedRooms:e.chat.searchedRooms,roomId:e.chat.roomId})))(a);s(33925);var l=s(13298),d=s(88560),h=s.n(d),u=s(86559),m=s(44102),p=s(29679);const g="image/x-png, image/png, image/jpg, image/jpeg, image/gif",f=g.split(",").map((e=>e.trim()));class x extends r.Component{constructor(){super(),this.sendTypingStatus=()=>{const{socket:e,chat:{roomId:t,currentRoom:s}}=this.props;e.emit("typing",{roomId:t,userId:s.user._id})},this.handleChange=e=>{const{socket:t,chat:{roomId:s,currentRoom:r}}=this.props;this.debouncedTyping(),clearTimeout(this.timer),this.setState({value:e.target.value}),this.timer=setTimeout((()=>{t.emit("stoppedTyping",{roomId:s,userId:r.user._id})}),3e3)},this.addEmoji=e=>{let t=e.native;this.setState({value:this.state.value+t})},this.handleSubmit=e=>{e.preventDefault();const{dispatch:t,chat:{roomId:s,currentRoom:r},userId:o}=this.props,{value:i}=this.state;""!==i&&t(n.O.sendMessage({receiver:r.user,value:i,roomId:s,sender:o,uuid:h()()})),this.setState({value:""})},this.toggleEmojiPicker=()=>{this.setState({showPicker:!this.state.showPicker})},this.handleFileSelect=e=>{const{dispatch:t,chat:{roomId:s,currentRoom:r},userId:o}=this.props,i=e.target.files;if(i&&i.length>0){if(this.verifyFile(i)){const e=i[0],a=new FileReader;a.addEventListener("load",(()=>{const e=a.result,i="image."+(0,p.FN)(e),c=(0,p.TP)(e,i),l=new FormData,d=h()();l.append("receiver",JSON.stringify(r.user)),l.append("roomId",s),l.append("uuid",d),l.append("photo",c,c.name),t(n.O.sendImage(l,{receiver:r.user,value:"Image",sender:o,roomId:s,uuid:d}))}),!1),a.readAsDataURL(e)}}},this.verifyFile=e=>{if(e&&e.length>0){const t=e[0],s=t.type,r=t.size,{dispatch:o}=this.props;return f.includes(s)?!(r>10485760)||(o(m.I.error("This file is not allowed. "+r+" bytes is too large")),!1):(o(m.I.error("This file is not allowed. Only images are allowed.")),!1)}},this.state={value:"",showPicker:!1},this.debouncedTyping=(0,u.P)(3e3,this.sendTypingStatus)}componentDidMount(){this.timer=null}render(){const{value:e}=this.state,t=this.state.showPicker?"grid":"none";return(0,i.jsxs)("div",{className:"message-input",children:[(0,i.jsx)("div",{style:{display:t,justifyItems:"end"},children:(0,i.jsx)(l.cW,{native:!0,onSelect:this.addEmoji})}),(0,i.jsxs)("div",{className:"wrap",children:[(0,i.jsx)("form",{onSubmit:this.handleSubmit,children:(0,i.jsx)("input",{onChange:this.handleChange,value:e,type:"text",placeholder:"Write your message..."})}),(0,i.jsxs)("label",{children:[(0,i.jsx)("input",{type:"file",accept:g,multiple:!1,onChange:this.handleFileSelect}),(0,i.jsx)("i",{className:"fa fa-paperclip","aria-hidden":"true"})]}),(0,i.jsx)("button",{onClick:this.toggleEmojiPicker,children:(0,i.jsx)("i",{className:"fa fa-smile-o","aria-hidden":"true"})})]})]})}}const j=(0,o.$j)((e=>({chat:e.chat,socket:e.socket.socket,userId:e.user.data._id})))(x);var S=s(61487),I=s(22417),y=s(45463),N=s(16303),E=s(40834),v=s(47823),w=s(84697),C=s(57532),_=s.n(C);class M extends r.Component{constructor(){super(),this.handleOpen=()=>{const{dispatch:e,currentRoom:t,roomId:s,socket:r}=this.props;this.mediaHandler.getPremissions().then((o=>{this.setState({hasMedia:!0}),this.stream=o,this.peer=new(_())({initiator:!0,stream:o,trickle:!1}),this.peer.on("error",(e=>{console.log(e)})),this.peer.on("stream",(e=>{this.userVideo.srcObject=e,this.userVideo.play()})),r.on("newAnswer",(e=>{this.peer.signal(e.webRtc)})),this.peer.on("signal",(r=>{e(n.O.call({currentRoom:t,roomId:s,webRtc:r}))})),this.peer.on("close",(()=>{this.mediaHandler.stopRecoring(),e(n.O.endCall()),this.setState({hasMedia:!1})})),this.myVideo.srcObject=o,this.myVideo.play()})).catch((e=>console.log(e)))},this.handleClose=()=>{const{dispatch:e}=this.props;this.peer.destroy(),this.mediaHandler.stopRecoring(),e(n.O.endCall()),this.setState({hasMedia:!1})},this.state={hasMedia:!1},this.stream=null,this.mediaHandler=new w.S}render(){const{callingModal:e}=this.props;return(0,i.jsxs)(v.Z,{open:e,trigger:(0,i.jsx)("i",{onClick:this.handleOpen,className:"fa fa-video-camera","aria-hidden":"true"}),children:[(0,i.jsxs)(v.Z.Content,{children:[(0,i.jsx)("video",{style:{width:300,height:"auto"},ref:e=>{this.myVideo=e}}),(0,i.jsx)("video",{style:{width:300,height:"auto"},ref:e=>{this.userVideo=e}})]}),(0,i.jsx)(v.Z.Actions,{children:(0,i.jsx)(E.Z,{negative:!0,onClick:this.handleClose,children:"End call"})})]})}}const T=(0,o.$j)((e=>({userId:e.user.data._id,profilePicture:e.user.data.profilePicture,callingModal:e.chat.callingModal,socket:e.socket.socket,currentRoom:e.chat.currentRoom,roomId:e.chat.roomId})))(M);var R=s(35667),O=s(11589),b=s.n(O),k=s(58612),A=s(97202),P=s.n(A),G=s(47749),F=s.n(G),q=s(97892),D=s.n(q),L=s(40130),U=s.n(L);D().extend(U()),P()(k),F()(k);const J={formatHref:function(e,t){return"hashtag"===t&&(e="/hashtags/"+e.substring(1)),"mention"===t&&(e="/"+e.substring(1)),e},attributes:{target:{url:"_blank"}}};function Z(e){let{show:t,image:s}=e;return t?(0,i.jsx)("img",{src:"/images/profile-picture/100x100/".concat(s),alt:""}):(0,i.jsx)("div",{})}const H=e=>{let{message:t,userId:s,profilePicture:r,currentRoom:o}=e;return t.sender===s?!1===t.sent?(0,i.jsxs)("li",{className:"replies",children:[(0,i.jsx)(Z,{image:r,show:t.picture}),(0,i.jsx)("p",{style:{backgroundColor:"#f5f5f5",color:"black",border:"1px solid grey",wordWrap:"break-word"},children:(0,i.jsx)(b(),{options:J,children:t.value})})]},t.uuid):"text"===t.messageType?(0,i.jsxs)("li",{className:"replies",children:[(0,i.jsx)(Z,{image:r,show:t.picture}),(0,i.jsx)(y.Z,{content:D()(t.createdAt).fromNow()+", seen:"+t.read,trigger:(0,i.jsx)("p",{children:(0,i.jsx)(b(),{options:J,children:t.text})})})]}):(0,i.jsxs)("li",{className:"replies",children:[(0,i.jsx)(Z,{image:r,show:t.picture}),(0,i.jsx)(y.Z,{content:D()(t.createdAt).fromNow()+", seen:"+t.read,trigger:(0,i.jsx)("img",{style:{borderRadius:"3%",objectFit:"cover",width:"40%",height:"20%"},src:"/images/chat-images/".concat(t.photo),alt:""})})]}):!1===t.sent?(0,i.jsxs)("li",{className:"sent",children:[(0,i.jsx)(Z,{image:o.user.profilePicture,show:t.picture}),(0,i.jsx)("p",{style:{backgroundColor:"#f5f5f5",color:"black",border:"1px solid grey",wordWrap:"break-word"},children:(0,i.jsx)(b(),{options:J,children:t.value})})]},t.uuid):"text"===t.messageType?(0,i.jsxs)("li",{className:"sent",children:[(0,i.jsx)(Z,{image:o.user.profilePicture,show:t.picture}),(0,i.jsx)(y.Z,{content:D()(t.createdAt).fromNow()+", seen:"+t.read,trigger:(0,i.jsxs)("p",{children:[" ",(0,i.jsx)(b(),{options:J,children:t.text})]})})]}):(0,i.jsxs)("li",{className:"sent",children:[(0,i.jsx)(Z,{image:o.user.profilePicture,show:t.picture}),(0,i.jsx)(y.Z,{content:D()(t.createdAt).fromNow()+", seen:"+t.read,trigger:(0,i.jsx)("img",{style:{borderRadius:"3%",objectFit:"cover",width:"40%",height:"20%"},src:"/images/chat-images/".concat(t.photo),alt:""})})]})};class z extends r.Component{constructor(){super(),this.componentDidMount=()=>{const{dispatch:e,currentRoom:t,roomId:s,userId:r,content:o}=this.props;if(o.messages.length){const t=o.messages.filter((e=>e.receiver===r&&!e.read)).map((e=>e._id));t.length&&e(n.O.readMessages({messageIds:t,roomId:s}))}else e(n.O.getMessagesForRoom({...t,initialFetch:!0}));this.handleScrollToBottom()},this.componentDidUpdate=()=>{const{dispatch:e,roomId:t,content:s,userId:r}=this.props,o=s.messages.filter((e=>e.receiver===r&&!e.read)).map((e=>e._id));o.length&&e(n.O.readMessages({messageIds:o,roomId:t})),this.scrollToBottom()},this.handleScrollToBottom=()=>{R.NY.scrollToBottom({containerId:"ContainerElementID",duration:500,delay:0})},this.fetchMessages=()=>{const{dispatch:e,currentRoom:t,content:s}=this.props,r=s.messages[0]._id;e(n.O.getMessagesForRoom({...t,lastId:r,initialFetch:!1}))},this.messagesContainer=r.createRef()}scrollToBottom(){this.messagesContainer.current.scrollHeight-this.messagesContainer.current.scrollTop-this.messagesContainer.current.clientHeight<350&&R.NY.scrollToBottom({containerId:"ContainerElementID",duration:200,delay:0})}render(){const{currentRoom:e,content:t,userId:s,profilePicture:r}=this.props,o=e.messages-t.messages.length,n=t.messages.map((t=>(0,i.jsx)(H,{currentRoom:e,message:t,userId:s,profilePicture:r},t._id||t.uuid)));return(0,i.jsxs)("div",{className:"content",children:[t.initialMessagesFetchig?(0,i.jsx)(S.Z,{active:!0,children:(0,i.jsx)(I.Z,{})}):null,(0,i.jsxs)("div",{className:"contact-profile",children:[(0,i.jsx)("img",{src:"/images/profile-picture/100x100/".concat(e.user.profilePicture),alt:""}),(0,i.jsx)("p",{children:e.user.firstName+" "+e.user.lastName}),(0,i.jsxs)("div",{className:"social-media",children:[(0,i.jsx)(y.Z,{content:"Scroll to bottom.",trigger:(0,i.jsx)("i",{onClick:this.handleScrollToBottom,className:"fa fa-arrow-down","aria-hidden":"true"})}),(0,i.jsx)(T,{}),(0,i.jsx)(N.Z,{basic:!0,color:"red",pointing:"left",children:"This isn't working."})]})]}),(0,i.jsxs)("div",{className:"messages",id:"ContainerElementID",ref:this.messagesContainer,children:[o?(0,i.jsxs)(E.Z,{fluid:!0,disabled:t.messageFetching,loading:t.messageFetching,onClick:this.fetchMessages,children:["Load ",e.messages-t.messages.length," more"]}):null,(0,i.jsxs)("ul",{children:[n,t.isTyping?(0,i.jsxs)("li",{className:"sent",children:[(0,i.jsx)("img",{src:"/images/profile-picture/100x100/".concat(e.user.profilePicture),alt:""}),(0,i.jsx)("p",{children:"typing..."})]},e.user._id):null]})]}),(0,i.jsx)(j,{})]})}}const Y=(0,o.$j)((e=>({userId:e.user.data._id,profilePicture:e.user.data.profilePicture,callingModal:e.chat.callingModal,socket:e.socket.socket,currentRoom:e.chat.currentRoom,roomId:e.chat.roomId})))(z);class B extends r.Component{constructor(){super(...arguments),this.componentDidMount=()=>{document.title="Messages | social-network"}}render(){const{chat:e,roomId:t}=this.props;return(0,i.jsxs)("div",{id:"frame",children:[(0,i.jsx)(c,{}),e.currentRoom?(0,i.jsx)(Y,{content:e[t]},t):null]})}}const V=(0,o.$j)((e=>({roomId:e.chat.roomId,chat:e.chat})))(B)},84697:(e,t,s)=>{"use strict";s.d(t,{S:()=>r});class r{constructor(){this.stream=null}getPremissions(){return new Promise(((e,t)=>{navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((t=>{this.stream=t,e(t)})).catch((e=>{throw new Error("Unable to fetch stream "+e)}))}))}stopRecoring(){this.stream.getTracks().forEach((function(e){e.stop()}))}}},17531:(e,t,s)=>{"use strict";s.d(t,{O:()=>i});var r=s(67035);const o={getChatRooms:function(){const e={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token}};return fetch("/api/chat/getChatRooms/",e).then(n).then((e=>e))},getMessagesForRoom:function(e){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify({...e})};return fetch("/api/chat/getMessagesForRoom/",t).then(n).then((e=>e))},sendMessage:function(e){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify({...e})};return fetch("/api/chat/sendMessage/",t).then(n).then((e=>e))},sendImage:function(e){const t={method:"POST",headers:{Authorization:JSON.parse(localStorage.getItem("user")).token},body:e};return fetch("/api/chat/sendImage/",t).then(n).then((e=>e))},readMessages:function(e){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify({...e})};return fetch("/api/chat/readMessages/",t).then(n).then((e=>e))},call:function(e){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify({...e})};return fetch("/api/chat/call/",t).then(n).then((e=>e))},answer:function(e){const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify({...e})};return fetch("/api/chat/answer/",t).then(n).then((e=>e))}};function n(e){return e.text().then((t=>{const s=t&&JSON.parse(t);if(!e.ok){401===e.status&&(localStorage.removeItem("user"),window.location.reload(!0));const t=s&&s.message||e.statusText;return Promise.reject(t)}return s}))}const i={typing:function(e){return t=>{t({type:r.q.TYPING,roomId:e})}},stoppedTyping:function(e){return t=>{t({type:r.q.STOPPED_TYPING,roomId:e})}},changeRoom:function(e){return t=>{t({type:r.q.CHANGE_ROOM,room:e})}},getChatRooms:function(){return e=>{e({type:r.q.GET_ROOMS_REQUEST}),o.getChatRooms().then((t=>{var s;e((s=t.rooms,{type:r.q.GET_ROOMS_SUCCESS,rooms:s})),t.rooms.forEach((t=>{return e((s=t._id,{type:r.q.INIT_MESSAGE_ARRAY,roomId:s}));var s}))}),(e=>{console.log(e)}))}},getMessagesForRoom:function(e){return t=>{var s;e.initialFetch?t((s=e._id,{type:r.q.GET_MESSAGES_INITIAL_REQUEST,roomId:s})):t(function(e){return{type:r.q.GET_MESSAGES_REQUEST,roomId:e}}(e._id)),o.getMessagesForRoom(e).then((s=>{var o;t((o={messages:s.messages.reverse(),roomId:e._id},{type:r.q.GET_MESSAGES_SUCCESS,data:o}))}),(e=>{console.log(e)}))}},sendMessage:function(e){return t=>{t(function(e){return{type:r.q.SEND_MESSAGE_REQUEST,message:e}}({...e,sent:!1})),o.sendMessage(e).then((e=>{t(function(e){return{type:r.q.SEND_MESSAGE_SUCCESS,message:e}}(e.message))}),(e=>{console.log(e)}))}},sendImage:function(e,t){return s=>{s(function(e){return{type:r.q.SEND_MESSAGE_REQUEST,message:e}}({...t,sent:!1})),o.sendImage(e).then((e=>{s(function(e){return{type:r.q.SEND_MESSAGE_SUCCESS,message:e}}(e.message))}),(e=>{console.log(e)}))}},newMessage:function(e){return t=>{t(function(e){return{type:r.q.NEW_MESSAGE,message:e}}(e)),t({type:r.q.INC_MESSAGE_COUNT})}},readMessages:function(e){const{messageIds:t,roomId:s}=e;return n=>{n(function(e,t){return{type:r.q.READ_MESSAGES,messageIds:e,roomId:t}}(t,s)),o.readMessages(e).then((()=>{}),(e=>{console.log(e)}))}},changeActivityStatus:function(e){return t=>{t({type:r.q.CHANGE_ACTIVITY_STATUS,user:e})}},imageMessageRequest:function(e){return t=>{t(function(e){return{type:r.q.NEW_IMAGE_MESSAGE_REQUEST,message:e}}(e))}},call:function(e){return t=>{t({type:r.q.OPEN_CALLING_MODAL}),o.call(e).then((()=>{}),(e=>{console.log(e)}))}},answer:function(e){return t=>{o.answer(e).then((()=>{}),(e=>{console.log(e)}))}},endCall:function(){return e=>{e({type:r.q.CLOSE_CALLING_MODAL})}},endAnsweringCall:function(){return e=>{e({type:r.q.CLOSE_ANSWERING_MODAL})}},searchUsers:function(e){return t=>{t({type:r.q.SEARCH_USERS,rooms:e})}}}},29679:(e,t,s)=>{"use strict";function r(e,t){for(var s=e.split(","),r=s[0].match(/:(.*?);/)[1],o=atob(s[1]),n=o.length,i=new Uint8Array(n);n--;)i[n]=o.charCodeAt(n);return new File([i],t,{type:r})}function o(e){return e.substring(11,e.indexOf(";base64"))}function n(e,t,s){const r=e;r.width=s.width,r.height=s.height;const o=r.getContext("2d"),n=new Image;n.src=t,n.onload=function(){o.drawImage(n,s.x,s.y,s.width,s.height,0,0,s.width,s.height)}}s.d(t,{FN:()=>o,TP:()=>r,tI:()=>n})},52361:()=>{},94616:()=>{}}]);
//# sourceMappingURL=422.010f6403.chunk.js.map